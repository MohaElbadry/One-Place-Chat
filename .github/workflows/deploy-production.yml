name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_deployment == 'DEPLOY'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate production readiness
        run: |
          echo "üîç Validating production readiness..."
          
          # Check if main branch
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå Production deployment only allowed from main branch"
            exit 1
          fi
          
          # Check if all required secrets are present
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "‚ùå Missing OPENAI_API_KEY"
            exit 1
          fi
          
          echo "‚úÖ Production readiness validation passed"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create production backup
        run: |
          echo "üíæ Creating production backup..."
          # Add backup logic here
          # Example: kubectl exec -it chromadb-pod -- pg_dump > backup-$(date +%Y%m%d-%H%M%S).sql

      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production..."
          
          # Set environment variables
          export ENVIRONMENT=production
          export BACKEND_IMAGE=ghcr.io/${{ github.repository }}-backend:latest
          export FRONTEND_IMAGE=ghcr.io/${{ github.repository }}-frontend:latest
          
          # Pull latest images
          docker pull $BACKEND_IMAGE
          docker pull $FRONTEND_IMAGE
          
          # Deploy with zero-downtime strategy
          docker-compose -f devops/docker/docker-compose.yml \
            -f devops/docker/docker-compose.production.yml \
            up -d --no-deps backend
          
          # Wait for backend to be healthy
          timeout 120 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 5; done'
          
          # Deploy frontend
          docker-compose -f devops/docker/docker-compose.yml \
            -f devops/docker/docker-compose.production.yml \
            up -d --no-deps frontend

      - name: Run production health checks
        run: |
          echo "üè• Running production health checks..."
          
          # Comprehensive health checks
          curl -f https://yourapp.com/api/health
          curl -f https://yourapp.com/api/tools
          curl -f https://yourapp.com/api/conversations
          
          # Check response times
          response_time=$(curl -o /dev/null -s -w '%{time_total}' https://yourapp.com/api/health)
          if (( $(echo "$response_time > 2.0" | bc -l) )); then
            echo "‚ö†Ô∏è High response time: ${response_time}s"
          fi
          
          echo "‚úÖ All health checks passed!"

      - name: Run load tests
        run: |
          echo "‚ö° Running load tests..."
          # Add load testing here
          # Example: k6 run load-tests/production-load-test.js

      - name: Update deployment status
        run: |
          echo "üìä Updating deployment status..."
          # Add status update logic here
          # Example: Update deployment dashboard, send metrics

      - name: Notify successful deployment
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            üéâ Production deployment successful!
            Environment: Production
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
        if: success()

      - name: Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Rolling back deployment..."
          # Add rollback logic here
          # Example: kubectl rollout undo deployment/backend
          # Example: docker-compose -f docker-compose.production.yml down

      - name: Notify failed deployment
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            üö® Production deployment failed!
            Environment: Production
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Action required: Check logs and rollback if necessary
        if: failure()
