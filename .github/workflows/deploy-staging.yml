name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - preview

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Deploying to ${{ github.event.inputs.environment }}..."
          
          # Set environment variables
          export ENVIRONMENT=${{ github.event.inputs.environment }}
          export BACKEND_IMAGE=ghcr.io/${{ github.repository }}-backend:latest
          export FRONTEND_IMAGE=ghcr.io/${{ github.repository }}-frontend:latest
          
          # Pull latest images
          docker pull $BACKEND_IMAGE
          docker pull $FRONTEND_IMAGE
          
          # Deploy with docker-compose
          docker-compose -f devops/docker/docker-compose.yml \
            -f devops/docker/docker-compose.${{ github.event.inputs.environment }}.yml \
            up -d

      - name: Wait for services
        run: |
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          
          # Check backend health
          timeout 60 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 5; done'
          
          # Check frontend health
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          
          # Test backend API
          curl -f http://localhost:3001/api/health
          curl -f http://localhost:3001/api/tools
          
          # Test frontend
          curl -f http://localhost:3000
          
          echo "‚úÖ All smoke tests passed!"

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        if: success()

      - name: Notify deployment failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        if: failure()
